<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JDChat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-50 min-h-screen flex items-center justify-center p-4">
  
  <!-- Username Modal (shows first time) -->
  <div id="usernameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4 shadow-2xl">
      <div class="text-center mb-6">
        <div class="w-20 h-20 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full mx-auto flex items-center justify-center text-3xl text-white shadow-2xl mb-4">
          <i class="fas fa-user"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Enter your name</h2>
        <p class="text-gray-600">Choose a display name for the chat</p>
      </div>
      <input id="usernameInput" type="text" placeholder="Your name..." maxlength="20"
        class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg text-center mb-6" />
      <button id="joinBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 text-lg">
        Join Chat
      </button>
    </div>
  </div>

  <!-- Main Chat (hidden until joined) -->
  <div id="chatContainer" class="w-full max-w-md bg-white rounded-3xl shadow-2xl overflow-hidden hidden">
    <!-- Header with online users -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 text-white relative">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
            <i class="fas fa-comments text-xl"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold" id="chatTitle">WebSocket Chat</h2>
            <p id="onlineCount" class="text-indigo-100 text-sm">online</p>
          </div>
        </div>
        <div id="userAvatar" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-lg">
          <i class="fas fa-user"></i>
        </div>
      </div>
    </div>

    <!-- Messages -->
    <div id="messages" class="h-96 overflow-y-auto p-6 space-y-4 bg-gray-50">
      <!-- Messages appear here -->
    </div>

    <!-- Input -->
    <div class="p-6 bg-white border-t">
      <div class="flex items-end gap-3">
        <div class="flex-1 relative">
          <input id="messageInput" type="text" placeholder="Type your message..." 
            class="w-full p-4 pr-12 rounded-2xl bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all duration-300" />
          <button class="absolute right-3 bottom-3 text-gray-400 hover:text-indigo-500">
            <i class="fas fa-paperclip text-lg"></i>
          </button>
        </div>
        <button id="sendBtn" class="w-14 h-14 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-3xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all flex items-center justify-center">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      <div id="typingIndicator" class="hidden mt-3 flex items-center gap-2 text-sm text-gray-500">
        <div class="flex gap-1">
          <div class="w-2 h-2 bg-indigo-500 rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
          <div class="w-2 h-2 bg-indigo-300 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
        <span id="typingText"></span>
      </div>
    </div>
  </div>

  <script>
    const socket = new WebSocket('wss://jdchat-production.up.railway.app');
    const usernameModal = document.getElementById('usernameModal');
    const chatContainer = document.getElementById('chatContainer');
    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const typingText = document.getElementById('typingText');
    const usernameInput = document.getElementById('usernameInput');
    const joinBtn = document.getElementById('joinBtn');
    const userAvatar = document.getElementById('userAvatar');
    const onlineCount = document.getElementById('onlineCount');
    const chatTitle = document.getElementById('chatTitle');

    let currentUser = '';
    let typingTimer;
    let onlineUsers = 0;

    // Join chat
    joinBtn.addEventListener('click', () => {
      const username = usernameInput.value.trim();
      if (username) {
        currentUser = username;
        socket.send(JSON.stringify({ type: 'username', username }));
        usernameModal.classList.add('hidden');
        chatContainer.classList.remove('hidden');
        
        // Update UI
        userAvatar.innerHTML = username[0].toUpperCase();
        chatTitle.textContent = `${username}'s Chat`;
        addMessage(`Welcome ${username}! ðŸ‘‹`);
      }
    });

    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') joinBtn.click();
    });

    // Enhanced message with profile
    function addMessage(data, isOwn = false) {
      const timeStr = new Date(data.timestamp || Date.now()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      const div = document.createElement('div');
      div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} animate-slideIn${isOwn ? 'Right' : 'Left'}`;
      
      div.innerHTML = `
        <div class="flex items-start gap-3 max-w-[85%]">
          ${!isOwn ? `
            <div class="w-10 h-10 bg-gradient-to-br from-${Math.floor(Math.random()*16777215).toString(16)} to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
              ${data.username[0].toUpperCase()}
            </div>
          ` : ''}
          <div class="p-4 rounded-2xl shadow-lg ${isOwn 
            ? 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white' 
            : 'bg-white border border-gray-200 shadow-sm'}">
            ${!isOwn ? `<div class="font-semibold text-sm mb-1">${data.username}</div>` : ''}
            <p class="text-sm leading-relaxed">${data.text}</p>
            <span class="text-xs opacity-75 mt-1 block">${timeStr}</span>
          </div>
          ${isOwn ? `
            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
              ${data.username[0].toUpperCase()}
            </div>
          ` : ''}
        </div>
      `;
      
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Typing
    input.addEventListener('input', () => {
      clearTimeout(typingTimer);
      socket.send(JSON.stringify({type: 'typing', isTyping: true}));
      typingTimer = setTimeout(() => {
        socket.send(JSON.stringify({type: 'typing', isTyping: false}));
      }, 1500);
    });

    function sendMessage() {
      const text = input.value.trim();
      if (!text || socket.readyState !== WebSocket.OPEN) return;
      socket.send(JSON.stringify({type: 'message', text }));
      input.value = '';
    }

    // Socket events
    socket.addEventListener('open', () => {
      console.log('Connected');
    });

    socket.addEventListener('message', (event) => {
      const data = JSON.parse(event.data);
      
      if (data.type === 'typing') {
        typingIndicator.classList.toggle('hidden', !data.isTyping);
        if (data.isTyping) {
          typingText.textContent = `${data.username} is typing...`;
        }
        return;
      }
      
      if (data.type === 'message') {
        addMessage(data, data.username === currentUser);
      }
    });

    // UI Events
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Animations & Scrollbar
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
      @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
      .animate-slideInLeft { animation: slideInLeft 0.3s ease-out; }
      .animate-slideInRight { animation: slideInRight 0.3s ease-out; }
      #messages::-webkit-scrollbar { width: 6px; }
      #messages::-webkit-scrollbar-track { background: transparent; }
      #messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
